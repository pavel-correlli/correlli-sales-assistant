# Data Consistency: Supabase vs Streamlit

## Симптом
- В Supabase (например, `v_ceo_iron_metrics`) объёмы звонков по менеджерам значительно больше, чем на страницах Streamlit (CSO/CEO/CMO).
- Пример: у менеджера ожидаемо ~233 звонка, а на сайте отображается ~23.

## Корневая причина
1) **Ограничение выдачи через API (PostgREST max rows)**  
Даже при `limit(...)` Supabase API может отдавать только первую страницу данных. Без пагинации приложение получает неполный датасет.

2) **Persisted state у Streamlit widgets**  
`st.date_input` и другие виджеты сохраняют значения между перезапусками кода в рамках сессии браузера. Изменение “дефолта” в коде не меняет фактический выбранный диапазон у уже открытой сессии.

3) **Сравнение “all-time” view и time-filtered UI**  
`v_ceo_iron_metrics` агрегирует всю таблицу без фильтра по датам. UI часто применяется к выбранному периоду (даже если пользователь не считал это фильтром).

## Решение в проекте
### 1) Полная выгрузка данных из Supabase
- `fetch_view_data` в `database.py` реализован с пагинацией через `.range(from, to)` до пустой страницы.
- Дополнительно фиксируется `supabase_exact_count` в `DataFrame.attrs` для проверки “ожидаемо” vs “загружено”.

### 1b) Единая логика времени
- Во всех фильтрах и расчётах используется `call_datetime` (ISO с таймзоной) → `call_date`.
- Колонка `date` больше не используется как источник истины для времени.

### 2) Управление периодом и сброс фильтров
- В sidebar добавлен `All time`, который отключает date-filter.
- Добавлен `Reset filters`, который очищает ключи фильтров из `st.session_state` и принудительно пересоздаёт виджеты.

### 3) Прозрачная диагностика
- На CSO странице есть `Data Health & Volume`, который показывает:
  - сколько строк загружено из Supabase
  - сколько строк осталось после каждого шага фильтрации (date/market/pipeline/manager)
  - min/max даты в результирующем наборе
- В Data Lab добавлен блок сравнения:
  - per-manager `Algonova_Calls_Raw` (count of rows)
  - per-manager `v_ceo_iron_metrics.total_calls_volume`

## Как проверять корректность
1) Открыть Data Lab → “Data Consistency Check” и сравнить totals и топ-менеджеров.
2) На CSO раскрыть “Data Health & Volume” и убедиться, что `Total Records Loaded from DB` ≈ объёму в Supabase.
3) Включить `All time` и сравнить распределение с `v_ceo_iron_metrics`.
